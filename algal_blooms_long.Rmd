---
title: |
  ![](Lynker-Logo.png){width=1in} 
  
  Real-time Remote Sensing Algal Bloom Report: 7/5 - 7/19 
editor_options:
  chunk_output_type: console
output:
  html_document:
    df_print: paged
    fig_caption: yes
    toc: true
    toc_float: true
    theme: yeti
  pdf_document: default
---

```{r setup data, include = FALSE}

# Adapted from:
# Keith Jennings
# kjennings@lynker.com
# 2021-10-25

# Nayoung Hur
# and
# Rachel Bash
# Report for Marston Reservoir

# Load packages
library(tidyverse)
library(cowplot); theme_set(theme_cowplot())
library(lubridate)
library(RColorBrewer)
library(knitr)
library(kableExtra)
library(flextable)
library(tinytex)
library(janitor)

options(knitr.duplicate.label = "allow")
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

# Load data ----


# Source date functions
devtools::source_url("https://raw.githubusercontent.com/SnowHydrology/date_functions/main/doy_dowy.R")

# Define working directory
# dir <- "~/Documents/Lynker.nosync/denverwater/" # Nayoung's directory
source("utils/find_google_drive.R") # drive_dir



##################################
##### read in satellite data #####
##################################

#year <- "2020"

date1 <- "2022-04-01"
date2 <- "2022-07-19"
date2minus14 <- "2022-07-05"

# Read csv data into R
df <- read.csv(paste0(drive_dir, "/pts__sentinel2_toa_", date1, "_", date2, ".csv"))

# Add sensor and date columns
df <- df %>% 
  mutate(system.index = case_when(str_sub(system.index, 1, 2) == "20" ~ 
                                    paste0("SE02_123456_", system.index),
                                  TRUE ~ system.index),
         sensor = str_sub(system.index, 1, 4),
         date = str_sub(system.index, 13, 20) %>% as.Date(format = "%Y%m%d"),
         waterbody = paste0(str_to_title(reservoir_), " Reservoir")) %>% 
  select(-.geo)

# Remove system.index and extra QA columns
df <- df %>% 
  select(., -system.index, -QA60)

# Add date information
df <- df %>% 
  mutate(year = year(date),
         month = month(date),
         doy = doy_FUN(date))

# Export as RDS file
df %>% 
  saveRDS(paste0(drive_dir, "sensors_all_aggregated_", date1, "_", date2, ".RDS"))


# Comparison script for remote sensing output versus chl-a sampling ----


# add looplist
looplist <- read.csv(paste0(drive_dir, "/rmarkdown/waterbody_list.csv")) %>%
  clean_names()

value.to.match <- looplist[1,1]

# Define thresholds
fai_thresh = 0.05
ndwi_thresh = 0.63
nir_red_thresh = 1

```


## Executive Summary

This report presents maps and time series data of potential algal blooms and harmful algal blooms (HABs) in several of Denver Water’s reservoirs. Algal blooms are formed when blue-green algae (also called cyanobacteria) rapidly multiply, resulting in a dense cyanobacteria concentration, or "bloom". The blooms can become harmful if the blue-green algae produces toxins. The reservoirs in this report were identified by Denver Water staff as medium and high priority locations to monitor for increased algal bloom activity. 



```{r map all res, echo = FALSE, out.width = '100%'}
# 
knitr::include_graphics(paste0(drive_dir, "/nir_red/All Waterbodies.jpg"))
```
*Map of all reservoirs in the report.*

### Key Results

The NIR:Red ratio exceeded 1, indicating presence of higher algal concentrations (which may affect taste and odor of water), at the following reservoirs between `r date2minus14` and `r date2`:

- Antero Reservoir*
- Bambei Walker Reservoir
- Chatfield Reservoir
- Dillon Reservoir
- Dunes Reservoir
- Gross Reservoir*
- Marston Reservoir
- Platte Canyon Reservoir
- Ralston Reservoir
- Strontia Springs Reservoir
- Tanabe Reservoir
- Williams Fork Reservoir*

A * indicates reservoirs that had less than three satellite observations between `r date2minus14` and `r date2`.

The FAI-NDWI algorithm met the conditions for cyanobacteria (indicating possible occurance of harmful algal blooms) for the following reservoirs between `r date2minus14` and `r date2`:

- Dillon Reservoir



#### Disclaimer

These results use a remote-sensing based algorithm to detect conditions that typically coincide with algae growth. These results DO NOT indicate the presence of *toxic* algae or associated constituents. Harmful algal blooms, and the resulting public health impacts, must be verified with laboratory measurements.


### Interpreting Results

The two algorithms employed in the analysis tell us two different things. The NIR:Red ratio increases as with algal concentrations. Dense concentrations of algae on the water surface can yield taste and odor issues. The FAI and NDWI algorithms together can evaluate cyanobacteria presence, which can potentially indicate cyanotoxins that create harmful algal blooms. 

If a reservoir's results between `r date2minus14` and `r date2` shows the NIR:Red ratio exceeding its threshold in meaningful ways, the following message will appear at the beginning of the reservoir section:


---

<span style="color: orange;">*NIR:Red threshold exceedance:*
Algae growth detected in remote sensing algorithm, this may affect taste and odor issues in the water. </span>

---


If a reservoir does not show *meaningful* algae growth that exceeds the NIR:Red exceedance threshold, the following message will appear at the beginning of the reservoir section:


---

<span style="color: green;">*NO meaningful NIR:Red threshold exceedance*  </span>

---


If a reservoir's results between `r date2minus14` and `r date2` meets the conditions for cyanobacteria according to the FAI-NDWI algorithm, the following message will appear at the beginning of the reservoir section:


---

<span style="color: red;">*FAI-NDWI threshold exccedance:*
Blue-Green Algae growth detected in remote sensing algorithm, this may indicate the occurrence of a harmful algal bloom.</span>

---

If a reservoir does not meet the conditions for cyanobacteria according to the FAI-NDWI algorithm, the following message will appear at the beginning of the reservoir section:


---

<span style="color: green;">*NO meaningful FAI-NDWI threshold exceedance*  </span>

---




Detection points were placed in 3-5 different areas around each reservoir. Clusters of points, spaced 10-20 meters apart, are labeled edge (E), near edge (NE), and open water (OW) to indicate the distance from shore. This is to help differentiate the satellite results during times of low water or high water. Clusters of points are labeled as MON, followed by a number, indicating which cluster of monitoring points they belong to. In addition to the monitoring points, some reservoirs have sites labeled as Chlorophyll Sampling Points, where previous in situ sampling of Chlorophyll-a has occurred. Maps of each studied reservoir will contain data between `r date2minus14` and `r date2`. The figure below shows an example of a portion of reservoir with high algae concentrations, according to the NIR:Red ratio exceedance threshold. 

```{r example, echo = FALSE, fig.align= 'right', out.width = '100%'}

knitr::include_graphics(paste0(drive_dir, "/images/example.png"))

```


All three points in the monitoring cluster (MON-01) are located within the maximum water surface, as confirmed with satellite imagery. According to the legend, the "open water" monitoring point is in a location where NIR:Red ratio threshold has been exceeded 8.9 - 10.9 times within the time period. **The black waterbody line is an approximation of the reservoir boundary and, at times, does not line up with the satellite imagery of the reservoir water level. The points labeled as "Edge" (E) signify the edge of the reservoir level at one point.** In the example above, the Edge point in the darkest shade of green is likely picking up land or mixed water-land pixels due to changes in reservoir level and area. 

It is important to note that these remote sensing approaches are subject to important assumptions and limitations, such as waterbody size, mixed land-water pixels, and atmospheric effects (cloud cover, haze). For instance, raster data and the associated color bands located outside of the black waterbody outline may be picking up land pixels. Therefore, using and understanding both the maps and the time series data for each point can help determine whether harmful blooms are taking place in each reservoir. 

Each reservoir's report will also include a timeseries plot of each monitoring cluster from the beginning of the summer, `r date1`, to the end of the current testing period, `r date2`. Edge, near edge, and open water NIR:Red ratio timeseries are displayed, along with the threshold exceedance line. If the NIR:Red ratio exceeds 1, then there is evidence of high algal concentrations. 

```{r timeseries, echo = FALSE, fig.align= 'right', out.width = '100%'}

knitr::include_graphics(paste0(drive_dir, "/images/timeseries.png"))

```


### Methods

This report uses processed output from the European Space Agency’s Sentinel 2 satellites to identify waterbodies experiencing algal growth and potential HABs.  Sentinel 2 is a high-resolution (10 meter) optical remote sensing platform, meaning it detects reflected radiation from the earth’s surface in and near the visible wavelengths of the electromagnetic spectrum. The imagery analyzed and presented is from the Level 1-C Top of Atmosphere product, over which we apply two key algorithms that relate satellite data to HABs presence:
  
  **NIR:Red:** the near infrared (NIR) to red band ratio, which corresponds to algae biomass on the water surface (Tebbs et al., 2013).The NIR:Red ratio is close to zero for clear water and increases with algae concentrations. In this report, we use values greater than 1 to indicate algae presence (Tebbs et al., 2013). NIR:Red is calculated in equation 1 below.



```{r nir red eq, echo = FALSE, fig.align= 'right', out.width = '100%'}

knitr::include_graphics(paste0(drive_dir, "/images/nir_red.png"))

```


where *R* represents the top of atmosphere reflectance (0–1) for a given band.

**FAI-NDWI:** This algorithm uses the floating algae index (FAI) and the normalized difference water index (NDWI) to detect potential cyanobacterial blooms (Oyama et al., 2015). First, the FAI differentiates between clear water and algae using a threshold of 0.05. The FAI considers values greater than or equal to 0.05 to be algae, while those below are clear water. Next, the NDWI partitions algae (i.e., pixels with FAI ≥ 0.05) into cyanobacteria and non-cyanobacteria blooms using a threshold of 0.63. Values greater than or equal to this threshold are considered probable cyanobacterial blooms while those below are not. This algorithm is described in equations 2 and 3 below.

```{r fai eq, echo = FALSE, fig.align= 'right', out.width = '100%'}

knitr::include_graphics(paste0(drive_dir, "/images/fai.png"))

```

```{r ndwi eq, echo = FALSE, fig.align= 'right', out.width = '100%'}

knitr::include_graphics(paste0(drive_dir, "/images/ndwi.png"))

```


We applied the above algorithms to the Sentinel 2 data in Google Earth Engine to evaluate temporal and spatial patterns of algae presence and potential cyanobacterial blooms, first removing all pixels obscured by clouds. With these data, we created a time series of the NIR:Red ratio and the FAI-NDWI cyanobacteria algorithm at a selection of points as described abov. In addition to the time series data, we also created maps for each waterbody showing the number of times each pixel exceeded a NIR:Red ratio greater than 1 and met the conditions for cyanobacteria according to the FAI-NDWI algorithm. 

Dense algae on the water surface can yield taste and odor issues, additionally cyanotoxins may be present in the water with cyanobacteria presence. Therefore, remote sensing is a valuable tool to map algal blooms and potential HABs because the data are continuous, frequent, and freely available. While remote sensing cannot determine toxicity, it offers near real time results and provides drinking water managers a tool to understand the seasonality and presence of algal blooms to assist in decision making. 

## Reservoirs

### Antero Reservoir

<span style="color: orange;">*NIR:Red threshold exceedance:*
Algae growth detected in remote sensing algorithm, this may affect taste and odor issues in the water. </span>

Please note however that there are only two instances of satellite observations during this two week period.

<span style="color: green;">*NO meaningful FAI-NDWI threshold exceedance*  </span>


```{r include=FALSE}
out = NULL

value.to.match <- looplist[1,1] 
out = c(out, knit_expand('waterbody_loop.Rmd'))

```
`r paste(knit(text = out), collapse = '\n')`


### Bambei-Walker Reservoir

<span style="color: orange;">*NIR:Red threshold exceedance:*
Algae growth detected in remote sensing algorithm, this may affect taste and odor issues in the water. </span>

<span style="color: green;">*NO meaningful FAI-NDWI threshold exceedance*  </span>


```{r include=FALSE}
out1 = NULL

value.to.match <- looplist[2,1] 
out1 = c(out1, knit_expand('waterbody_loop.Rmd'))

```
`r paste(knit(text = out1), collapse = '\n')`


### Chatfield Reservoir

<span style="color: orange;">*NIR:Red threshold exceedance:*
Algae growth detected in remote sensing algorithm, this may affect taste and odor issues in the water. </span>

<span style="color: green;">*NO meaningful FAI-NDWI threshold exceedance*  </span>

```{r include=FALSE}
out = NULL

value.to.match <- looplist[3,1] 
out = c(out, knit_expand('waterbody_loop.Rmd'))

```
`r paste(knit(text = out), collapse = '\n')`


### Cheesman Reservoir

<span style="color: green;">*NO meaningful NIR:Red threshold exceedance*  </span>

<span style="color: green;">*NO meaningful FAI-NDWI threshold exceedance*  </span>
    
```{r include=FALSE}
  out = NULL
  
  value.to.match <- looplist[4,1] 
  out = c(out, knit_expand('waterbody_loop.Rmd'))
  
```
`r paste(knit(text = out), collapse = '\n')`
  
  
### Dillon Reservoir
  
  Please note that Dillon Reservoir is on the edge of two satellite overpasses, resulting in raster maps that look a bit disjointed.
  
<span style="color: orange;">*NIR:Red threshold exceedance:*
Algae growth detected in remote sensing algorithm, this may affect taste and odor issues in the water. </span>

<span style="color: red;">*FAI-NDWI threshold exccedance:*
Blue-Green Algae growth detected in remote sensing algorithm, this may indicate the occurrence of a harmful algal bloom.</span>

```{r include=FALSE}
out = NULL
out = NULL

value.to.match <- looplist[5,1] 
out = c(out, knit_expand('waterbody_loop.Rmd'))

```
`r paste(knit(text = out), collapse = '\n')`


### Dunes Reservoir

<span style="color: orange;">*NIR:Red threshold exceedance:*
Algae growth detected in remote sensing algorithm, this may affect taste and odor issues in the water. </span>

<span style="color: green;">*NO meaningful FAI-NDWI threshold exceedance*  </span>

```{r include=FALSE}
out = NULL

value.to.match <- looplist[6,1] 
out = c(out, knit_expand('waterbody_loop.Rmd'))

```
`r paste(knit(text = out), collapse = '\n')`


### Gross Reservoir

<span style="color: orange;">*NIR:Red threshold exceedance:*
Algae growth detected in remote sensing algorithm, this may affect taste and odor issues in the water. </span>

Please note however that there are only two instances of satellite observations during this two week period.

<span style="color: green;">*NO meaningful FAI-NDWI threshold exceedance*  </span>
    
```{r include=FALSE}
  out = NULL
  
  value.to.match <- looplist[7,1] 
  out = c(out, knit_expand('waterbody_loop.Rmd'))
```
`r paste(knit(text = out), collapse = '\n')`
  
  
### Marston Reservoir
  
<span style="color: green;">*NO meaningful NIR:Red threshold exceedance*  </span>

<span style="color: green;">*NO meaningful FAI-NDWI threshold exceedance*  </span>
    
```{r include=FALSE}
  out = NULL
  
  value.to.match <- looplist[8,1] 
  out = c(out, knit_expand('waterbody_loop.Rmd'))
  
```
`r paste(knit(text = out), collapse = '\n')`
  
  
### Platte Canyon Reservoir
  
<span style="color: orange;">*NIR:Red threshold exceedance:*
Algae growth detected in remote sensing algorithm, this may affect taste and odor issues in the water. </span>

<span style="color: green;">*NO meaningful FAI-NDWI threshold exceedance*  </span>
    
```{r include=FALSE}
  out = NULL
  
  value.to.match <- looplist[9,1] 
  out = c(out, knit_expand('waterbody_loop.Rmd'))
  
```
`r paste(knit(text = out), collapse = '\n')`
  
  
### Ralston Reservoir
  
<span style="color: green;">*NO meaningful NIR:Red threshold exceedance*  </span>

<span style="color: green;">*NO meaningful FAI-NDWI threshold exceedance*  </span>
    
```{r include=FALSE}
  out = NULL
  
  value.to.match <- looplist[10,1] 
  out = c(out, knit_expand('waterbody_loop.Rmd'))

```
`r paste(knit(text = out), collapse = '\n')`
  
  
### Strontia Springs Reservoir
  
<span style="color: orange;">*NIR:Red threshold exceedance:*
Algae growth detected in remote sensing algorithm, this may affect taste and odor issues in the water. </span>

<span style="color: green;">*NO meaningful FAI-NDWI threshold exceedance*  </span>

```{r include=FALSE}
out = NULL

value.to.match <- looplist[11,1] 
out = c(out, knit_expand('waterbody_loop.Rmd'))

```
`r paste(knit(text = out), collapse = '\n')`


### Tanabe Reservoir

<span style="color: orange;">*NIR:Red threshold exceedance:*
Algae growth detected in remote sensing algorithm, this may affect taste and odor issues in the water. </span>

<span style="color: green;">*NO meaningful FAI-NDWI threshold exceedance*  </span>

```{r include=FALSE}
out = NULL

value.to.match <- looplist[12,1] 
out = c(out, knit_expand('waterbody_loop.Rmd'))

```
`r paste(knit(text = out), collapse = '\n')`


### Welby Reservoir

<span style="color: green;">*NO meaningful NIR:Red threshold exceedance*  </span>

<span style="color: red;">*FAI-NDWI threshold exccedance:*
Blue-Green Algae growth detected in remote sensing algorithm, this may indicate the occurrence of a harmful algal bloom.</span>

```{r include=FALSE}
out = NULL

value.to.match <- looplist[13,1] 
out = c(out, knit_expand('waterbody_loop.Rmd'))

```
`r paste(knit(text = out), collapse = '\n')`


### Williams Fork Reservoir

<span style="color: orange;">*NIR:Red threshold exceedance:*
Algae growth detected in remote sensing algorithm, this may affect taste and odor issues in the water. </span>

Please note however that there are only two instances of observations during this two week time period.

<span style="color: green;">*NO meaningful FAI-NDWI threshold exceedance*  </span>
    
```{r include=FALSE}
  out = NULL
  
  value.to.match <- looplist[14,1] 
  out = c(out, knit_expand('waterbody_loop.Rmd'))
  
```
`r paste(knit(text = out), collapse = '\n')`
  
## Conclusions
  
  The following table summarizes all **open water** monitoring points in each reservoir between `r date1` and `r date2`. It is important to note that these exceedances are showing the presence of algal growth, not necessarily **harmful** algal blooms. Additionally, the relationship between chlorophyll-a sampling  NIR:Red ratio shows that, while there is a statistically significant positive relationship (Hur et al., 2022), they do not perfectly align. Water absorbs much of the incoming shortwave radiation emitted by the sun, which causes satellite sensors to report a greater amount of noise relative to the signal returned by low over-water reflectances. Functionally, this means that waterbodies with denser algal blooms return a more reliable signal. The NIR:Red ratio is therefore a less reliable indicator of absolute chlorophyll-a values in waterbodies with low chlorophyll-a concentrations. We also imposed empirically derived thresholds for determining cyanobacteria blooms. Such thresholds may not work for all waterbodies in different geographic regions.
  
```{r echo = FALSE}
  # Summary table
  
  # Import processed remote sensing data and chl-a data
  gee <- readRDS(paste0(drive_dir, "sensors_all_aggregated_", date1, "_", date2, ".RDS"))
  
  gee_table <- gee %>% 
    mutate(cyano = case_when(fai >= fai_thresh & ndwi >= ndwi_thresh ~ 1,
                             TRUE ~ 0))
  
  over_thresh <- gee_table %>% 
    filter(pt_loc == "OW") %>%
    group_by(waterbody) %>% 
    summarise(nir_red_n_over = sum(nir_red_br >= nir_red_thresh),
              fai_ndwi_n_over = sum(cyano),
              n_obs = n()) %>% 
    ungroup() %>%
    mutate(nir_red_pct_over = round(nir_red_n_over / n_obs * 100,1),
           fai_ndwi_pct_over = round(fai_ndwi_n_over / n_obs * 100,1)) %>%
    select(waterbody, n_obs, nir_red_n_over, nir_red_pct_over, 
           fai_ndwi_n_over, fai_ndwi_pct_over) %>%
    mutate(nir_combine = paste0(nir_red_n_over, " (", nir_red_pct_over, "%)"), 
           fai_combine = paste0(fai_ndwi_n_over, " (", fai_ndwi_pct_over, "%)"),
           n_obs = as.character(n_obs)) %>%
    select(waterbody, n_obs, nir_combine, fai_combine) %>%
    rename("Waterbody" = "waterbody",
           "Number of observations" = "n_obs",
           "NIR:Red exceedance count (%)" = "nir_combine",
           "FAI-NDWI exceedance count (%)" = "fai_combine")
  
  # Function to make table fit to page margins
  fitflextabletopage <- function(ft, pgwidth = 6){
    ft_out <- ft %>% autofit()
    ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
    return(ft_out)
  }
  
  over_thresh %>%
    flextable() %>%
    fitflextabletopage
  
```
  
  
  
  
## References
  
  Hur, N., Jennings, K., McKnight, D. (2022). Spatiotemporal Patterns of Algae and Cyanobacteria in Boulder OSMP Waterbodies, Technical Report.
  
  Oyama, Y., Matsushita, B., & Fukushima, T. (2015). Distinguishing surface cyanobacterial blooms and aquatic macrophytes using Landsat/TM and ETM+ shortwave infrared bands. *Remote Sensing of Environment*, 157, 35–47. https://doi.org/10.1016/j.rse.2014.04.031
  
  Tebbs, E. J., Remedios, J. J., & Harper, D. M. (2013). Remote sensing of chlorophyll-a as a measure of cyanobacterial biomass in Lake Bogoria, a hypertrophic, saline–alkaline, flamingo lake, using Landsat ETM+. *Remote Sensing of Environment*, 135, 92–106.
  
## Previous Reports
  
  
[Report draft 4/1 - 6/7](https://rachel-lynker.github.io/denverwater_algae/index-4.1_6.7.html)

[6/7-6/21 Report](https://rachel-lynker.github.io/denverwater_algae/index-6.7_6.21.html) 
  
  